@page "/email"
@using AutoJobApplication.Interfaces
@inject IEmailService EmailService
@inject IFileUploadService FileUploadService

<h3>Email Your CV</h3>

<input type="file" @onchange="HandleFileSelected" />
<p>@UploadMessage</p>

<input type="text" @bind="RecipientEmail" placeholder="Recipient Email" />
<textarea @bind="CoverLetter" placeholder="Cover Letter"></textarea>
<input type="text" @bind="EmailSubject" placeholder="Email Subject" />
<textarea @bind="EmailBody" placeholder="Email Body"></textarea>
<button @onclick="SendEmailNew">Send Email</button>

@code {
    private string RecipientEmail;
    private string CoverLetter;
    private string EmailSubject;
    private string EmailBody;
    private byte[] Attachment; // To hold the uploaded CV file
    private string UploadMessage = "";

    private async Task HandleFileSelected(ChangeEventArgs e)
    {
        var file = ((IBrowserFile)e.Value);
        if (file != null && (file.ContentType == "application/pdf" || file.ContentType == "application/vnd.openxmlformats-officedocument.wordprocessingml.document"))
        {
            // Use FileUploadService to read the file into a byte array
            Attachment = await FileUploadService.UploadFileAsync(file);
            UploadMessage = "File uploaded successfully.";
        }
        else
        {
            UploadMessage = "Invalid file format. Please upload a DOCX or PDF file.";
        }
    }

    private async Task SendEmailNew()
    {
        // Check if attachment is available before sending
        if (Attachment != null && Attachment.Length > 0)
        {
            await EmailService.SendEmailAsync(RecipientEmail, CoverLetter, EmailSubject, EmailBody, Attachment);
        }
        else
        {
            // Handle case where attachment is missing
            UploadMessage = "Please upload a valid CV file before sending.";
        }
    }
}
